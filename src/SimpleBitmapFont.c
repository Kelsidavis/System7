/*
 * SimpleBitmapFont.c - Simple built-in bitmap font for System 7.1
 * Provides a basic 8x8 monospace font for text rendering
 */

#include "SystemTypes.h"
#include "QuickDraw/QuickDraw.h"

/* External framebuffer from multiboot */
extern void* framebuffer;
extern uint32_t fb_width;
extern uint32_t fb_height;
extern uint32_t fb_pitch;
extern uint32_t pack_color(uint8_t r, uint8_t g, uint8_t b);

/* Simple 8x8 bitmap font - printable ASCII characters 32-126 */
static const unsigned char font8x8[][8] = {
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, /* Space */
    {0x18,0x18,0x18,0x18,0x18,0x00,0x18,0x00}, /* ! */
    {0x6C,0x6C,0x6C,0x00,0x00,0x00,0x00,0x00}, /* " */
    {0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00}, /* # */
    {0x18,0x7E,0xC0,0x7C,0x06,0xFC,0x18,0x00}, /* $ */
    {0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00}, /* % */
    {0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00}, /* & */
    {0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00}, /* ' */
    {0x18,0x30,0x60,0x60,0x60,0x30,0x18,0x00}, /* ( */
    {0x60,0x30,0x18,0x18,0x18,0x30,0x60,0x00}, /* ) */
    {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00}, /* * */
    {0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00}, /* + */
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x30}, /* , */
    {0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00}, /* - */
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00}, /* . */
    {0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00}, /* / */
    {0x7C,0xC6,0xCE,0xDE,0xF6,0xE6,0x7C,0x00}, /* 0 */
    {0x30,0x70,0x30,0x30,0x30,0x30,0xFC,0x00}, /* 1 */
    {0x78,0xCC,0x0C,0x38,0x60,0xCC,0xFC,0x00}, /* 2 */
    {0x78,0xCC,0x0C,0x38,0x0C,0xCC,0x78,0x00}, /* 3 */
    {0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x1E,0x00}, /* 4 */
    {0xFC,0xC0,0xF8,0x0C,0x0C,0xCC,0x78,0x00}, /* 5 */
    {0x38,0x60,0xC0,0xF8,0xCC,0xCC,0x78,0x00}, /* 6 */
    {0xFC,0xCC,0x0C,0x18,0x30,0x30,0x30,0x00}, /* 7 */
    {0x78,0xCC,0xCC,0x78,0xCC,0xCC,0x78,0x00}, /* 8 */
    {0x78,0xCC,0xCC,0x7C,0x0C,0x18,0x70,0x00}, /* 9 */
    {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00}, /* : */
    {0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x30}, /* ; */
    {0x18,0x30,0x60,0xC0,0x60,0x30,0x18,0x00}, /* < */
    {0x00,0x00,0x7E,0x00,0x7E,0x00,0x00,0x00}, /* = */
    {0x60,0x30,0x18,0x0C,0x18,0x30,0x60,0x00}, /* > */
    {0x3C,0x66,0x0C,0x18,0x18,0x00,0x18,0x00}, /* ? */
    {0x7C,0xC6,0xDE,0xDE,0xDE,0xC0,0x78,0x00}, /* @ */
    {0x30,0x78,0xCC,0xCC,0xFC,0xCC,0xCC,0x00}, /* A */
    {0xFC,0x66,0x66,0x7C,0x66,0x66,0xFC,0x00}, /* B */
    {0x3C,0x66,0xC0,0xC0,0xC0,0x66,0x3C,0x00}, /* C */
    {0xF8,0x6C,0x66,0x66,0x66,0x6C,0xF8,0x00}, /* D */
    {0xFE,0x62,0x68,0x78,0x68,0x62,0xFE,0x00}, /* E */
    {0xFE,0x62,0x68,0x78,0x68,0x60,0xF0,0x00}, /* F */
    {0x3C,0x66,0xC0,0xC0,0xCE,0x66,0x3E,0x00}, /* G */
    {0xCC,0xCC,0xCC,0xFC,0xCC,0xCC,0xCC,0x00}, /* H */
    {0x78,0x30,0x30,0x30,0x30,0x30,0x78,0x00}, /* I */
    {0x1E,0x0C,0x0C,0x0C,0xCC,0xCC,0x78,0x00}, /* J */
    {0xE6,0x66,0x6C,0x78,0x6C,0x66,0xE6,0x00}, /* K */
    {0xF0,0x60,0x60,0x60,0x62,0x66,0xFE,0x00}, /* L */
    {0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0x00}, /* M */
    {0xC6,0xE6,0xF6,0xDE,0xCE,0xC6,0xC6,0x00}, /* N */
    {0x38,0x6C,0xC6,0xC6,0xC6,0x6C,0x38,0x00}, /* O */
    {0xFC,0x66,0x66,0x7C,0x60,0x60,0xF0,0x00}, /* P */
    {0x78,0xCC,0xCC,0xCC,0xDC,0x78,0x1C,0x00}, /* Q */
    {0xFC,0x66,0x66,0x7C,0x6C,0x66,0xE6,0x00}, /* R */
    {0x78,0xCC,0xC0,0x78,0x0C,0xCC,0x78,0x00}, /* S */
    {0xFC,0xB4,0x30,0x30,0x30,0x30,0x78,0x00}, /* T */
    {0xCC,0xCC,0xCC,0xCC,0xCC,0xCC,0xFC,0x00}, /* U */
    {0xCC,0xCC,0xCC,0xCC,0xCC,0x78,0x30,0x00}, /* V */
    {0xC6,0xC6,0xC6,0xD6,0xFE,0xEE,0xC6,0x00}, /* W */
    {0xC6,0xC6,0x6C,0x38,0x6C,0xC6,0xC6,0x00}, /* X */
    {0xCC,0xCC,0xCC,0x78,0x30,0x30,0x78,0x00}, /* Y */
    {0xFE,0xC6,0x8C,0x18,0x32,0x66,0xFE,0x00}, /* Z */
    {0x78,0x60,0x60,0x60,0x60,0x60,0x78,0x00}, /* [ */
    {0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00}, /* \ */
    {0x78,0x18,0x18,0x18,0x18,0x18,0x78,0x00}, /* ] */
    {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00}, /* ^ */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF}, /* _ */
    {0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00}, /* ` */
    {0x00,0x00,0x78,0x0C,0x7C,0xCC,0x76,0x00}, /* a */
    {0xE0,0x60,0x60,0x7C,0x66,0x66,0xDC,0x00}, /* b */
    {0x00,0x00,0x78,0xCC,0xC0,0xCC,0x78,0x00}, /* c */
    {0x1C,0x0C,0x0C,0x7C,0xCC,0xCC,0x76,0x00}, /* d */
    {0x00,0x00,0x78,0xCC,0xFC,0xC0,0x78,0x00}, /* e */
    {0x38,0x6C,0x60,0xF0,0x60,0x60,0xF0,0x00}, /* f */
    {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0xF8}, /* g */
    {0xE0,0x60,0x6C,0x76,0x66,0x66,0xE6,0x00}, /* h */
    {0x30,0x00,0x70,0x30,0x30,0x30,0x78,0x00}, /* i */
    {0x0C,0x00,0x0C,0x0C,0x0C,0xCC,0xCC,0x78}, /* j */
    {0xE0,0x60,0x66,0x6C,0x78,0x6C,0xE6,0x00}, /* k */
    {0x70,0x30,0x30,0x30,0x30,0x30,0x78,0x00}, /* l */
    {0x00,0x00,0xCC,0xFE,0xFE,0xD6,0xC6,0x00}, /* m */
    {0x00,0x00,0xF8,0xCC,0xCC,0xCC,0xCC,0x00}, /* n */
    {0x00,0x00,0x78,0xCC,0xCC,0xCC,0x78,0x00}, /* o */
    {0x00,0x00,0xDC,0x66,0x66,0x7C,0x60,0xF0}, /* p */
    {0x00,0x00,0x76,0xCC,0xCC,0x7C,0x0C,0x1E}, /* q */
    {0x00,0x00,0xDC,0x76,0x66,0x60,0xF0,0x00}, /* r */
    {0x00,0x00,0x7C,0xC0,0x78,0x0C,0xF8,0x00}, /* s */
    {0x10,0x30,0x7C,0x30,0x30,0x34,0x18,0x00}, /* t */
    {0x00,0x00,0xCC,0xCC,0xCC,0xCC,0x76,0x00}, /* u */
    {0x00,0x00,0xCC,0xCC,0xCC,0x78,0x30,0x00}, /* v */
    {0x00,0x00,0xC6,0xD6,0xFE,0xFE,0x6C,0x00}, /* w */
    {0x00,0x00,0xC6,0x6C,0x38,0x6C,0xC6,0x00}, /* x */
    {0x00,0x00,0xCC,0xCC,0xCC,0x7C,0x0C,0xF8}, /* y */
    {0x00,0x00,0xFC,0x98,0x30,0x64,0xFC,0x00}, /* z */
    {0x1C,0x30,0x30,0xE0,0x30,0x30,0x1C,0x00}, /* { */
    {0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00}, /* | */
    {0xE0,0x30,0x30,0x1C,0x30,0x30,0xE0,0x00}, /* } */
    {0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00}  /* ~ */
};

/* Draw a single character at given position */
void DrawCharAt(short x, short y, char ch, uint32_t color) {
    if (!framebuffer) return;

    /* Handle only printable ASCII */
    if (ch < 32 || ch > 126) return;

    const unsigned char* bitmap = font8x8[ch - 32];
    uint32_t* fb = (uint32_t*)framebuffer;

    for (int row = 0; row < 8; row++) {
        if (y + row >= fb_height) break;

        unsigned char rowData = bitmap[row];
        for (int col = 0; col < 8; col++) {
            if (x + col >= fb_width) break;

            if (rowData & (0x80 >> col)) {
                /* Set pixel */
                int offset = (y + row) * (fb_pitch / 4) + (x + col);
                fb[offset] = color;
            }
        }
    }
}

/* Draw a string at given position */
void DrawStringAt(short x, short y, const char* str, uint32_t color) {
    if (!str) return;

    short currentX = x;
    while (*str) {
        DrawCharAt(currentX, y, *str, color);
        currentX += 8;  /* Move to next character position */
        str++;
    }
}

/* Draw a Pascal string at given position */
void DrawPStringAt(short x, short y, ConstStr255Param pstr, uint32_t color) {
    if (!pstr || pstr[0] == 0) return;

    short currentX = x;
    for (int i = 1; i <= pstr[0]; i++) {
        DrawCharAt(currentX, y, pstr[i], color);
        currentX += 8;
    }
}

/* Global pen position */
extern Point g_penPosition;

/* QuickDraw text functions - implement actual drawing */
void DrawChar(short ch) {
    extern GrafPtr g_currentPort;
    if (!g_currentPort || !framebuffer) return;

    /* Draw at current pen position with black */
    DrawCharAt(g_penPosition.h, g_penPosition.v, (char)ch, pack_color(0, 0, 0));

    /* Advance pen position */
    g_penPosition.h += 8;
}

void DrawString(ConstStr255Param s) {
    if (!s || s[0] == 0) return;

    for (int i = 1; i <= s[0]; i++) {
        DrawChar(s[i]);
    }
}

void DrawText(const void* textBuf, short firstByte, short byteCount) {
    if (!textBuf || byteCount <= 0) return;

    const char* text = (const char*)textBuf;
    for (short i = 0; i < byteCount; i++) {
        DrawChar(text[firstByte + i]);
    }
}

/* Text measurement functions */
short CharWidth(short ch) {
    return 8;  /* Fixed width font */
}

short StringWidth(ConstStr255Param s) {
    if (!s) return 0;
    return s[0] * 8;
}

short TextWidth(const void* textBuf, short firstByte, short byteCount) {
    if (!textBuf || byteCount <= 0) return 0;
    return byteCount * 8;
}

/* Initialize simple font (called from InitFonts) */
void InitSimpleFont(void) {
    /* Nothing to initialize for built-in font */
}