name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-x86:
    name: Build x86
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc-multilib \
            grub-pc-bin \
            xorriso \
            python3 \
            vim-common

      - name: Build kernel (English)
        run: make PLATFORM=x86

      - name: Build ISO (English)
        run: make iso

      - name: Display build info
        run: make info

      - name: Upload kernel artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernel-x86
          path: kernel.elf

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: system71-iso
          path: system71.iso

  build-locales:
    name: Build Locale ISO
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        lang:
          - en
          - de
          - es
          - fr
          - zh
          - tw

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc-multilib \
            grub-pc-bin \
            xorriso \
            python3 \
            vim-common

      - name: Verify resource generation
        run: |
          echo "Generating ${{ matrix.lang }} resources..."
          python3 gen_rsrc.py resources/strings/${{ matrix.lang }}.json /tmp/test_${{ matrix.lang }}.rsrc

      - name: Build kernel (single locale)
        run: |
          LANG_CODE="${{ matrix.lang }}"
          if [[ "$LANG_CODE" == "en" ]]; then
            make PLATFORM=x86
          else
            LANG_UPPER=$(echo "$LANG_CODE" | tr '[:lower:]' '[:upper:]')
            make PLATFORM=x86 "LOCALE_${LANG_UPPER}=1"
          fi

      - name: Build ISO
        run: make iso

      - name: Rename ISO
        run: mv system71.iso system71-${{ matrix.lang }}.iso

      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: system71-iso-${{ matrix.lang }}
          path: system71-${{ matrix.lang }}.iso

  build-all-locales:
    name: Build All Locales ISO
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc-multilib \
            grub-pc-bin \
            xorriso \
            python3 \
            vim-common

      - name: Build multi-language kernel
        run: make PLATFORM=x86 LOCALE_FR=1 LOCALE_DE=1 LOCALE_ES=1 LOCALE_JA=1 LOCALE_ZH=1 LOCALE_KO=1 LOCALE_RU=1 LOCALE_UK=1 LOCALE_PL=1 LOCALE_CS=1 LOCALE_SQ=1 LOCALE_BG=1 LOCALE_HR=1 LOCALE_DA=1 LOCALE_NL=1 LOCALE_ET=1 LOCALE_FI=1 LOCALE_EL=1 LOCALE_HU=1 LOCALE_IS=1 LOCALE_IT=1 LOCALE_LV=1 LOCALE_LT=1 LOCALE_MK=1 LOCALE_ME=1 LOCALE_NO=1 LOCALE_PT=1 LOCALE_RO=1 LOCALE_SK=1 LOCALE_SL=1 LOCALE_SV=1 LOCALE_TR=1 LOCALE_HI=1 LOCALE_TW=1 LOCALE_AR=1 LOCALE_BN=1 LOCALE_UR=1

      - name: Build multi-language ISO
        run: make iso

      - name: Upload multi-language ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: system71-iso-all-languages
          path: system71.iso


  build-arm:
    name: Build ARM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc-arm-linux-gnueabihf \
            python3 \
            vim-common

      - name: Build kernel (ARM)
        run: make PLATFORM=arm
        continue-on-error: true

      - name: Upload ARM kernel artifact
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: kernel-arm
          path: kernel.elf

  test-qemu:
    name: QEMU Boot Test
    runs-on: ubuntu-latest
    needs: build-x86

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            qemu-system-x86

      - name: Download ISO artifact
        uses: actions/download-artifact@v4
        with:
          name: system71-iso

      - name: Test QEMU boot (headless)
        run: |
          timeout 30s qemu-system-i386 \
            -cdrom system71.iso \
            -display none \
            -serial stdio \
            -m 256M \
            -no-reboot || true
          echo "QEMU boot test completed"
