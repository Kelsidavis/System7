name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-release:
    name: Build Release
    runs-on: ubuntu-latest
    # Only run if: tag push, manual trigger, or CI succeeded
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Get commit SHA
        id: get_sha
        run: |
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "SHA=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
            echo "IS_TAG=false" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "SHA=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "IS_TAG=true" >> $GITHUB_OUTPUT
            echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "SHA=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "IS_TAG=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.get_sha.outputs.SHA }}
          fetch-depth: 0  # Full history for version calculation

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc-multilib \
            grub-pc-bin \
            xorriso \
            python3 \
            vim-common

      - name: Build kernel (English)
        run: make PLATFORM=x86

      - name: Build ISO (English)
        run: make iso

      - name: Save English artifacts
        run: |
          cp kernel.elf kernel-en.elf
          cp system71.iso system71-en.iso

      - name: Build multi-language kernel
        run: |
          make clean
          make PLATFORM=x86 LOCALE_FR=1 LOCALE_DE=1 LOCALE_ES=1 LOCALE_JA=1 LOCALE_ZH=1 LOCALE_KO=1 LOCALE_RU=1 LOCALE_UK=1 LOCALE_PL=1 LOCALE_CS=1 LOCALE_SQ=1 LOCALE_BG=1 LOCALE_HR=1 LOCALE_DA=1 LOCALE_NL=1 LOCALE_ET=1 LOCALE_FI=1 LOCALE_EL=1 LOCALE_HU=1 LOCALE_IS=1 LOCALE_IT=1 LOCALE_LV=1 LOCALE_LT=1 LOCALE_MK=1 LOCALE_ME=1 LOCALE_NO=1 LOCALE_PT=1 LOCALE_RO=1 LOCALE_SK=1 LOCALE_SL=1 LOCALE_SV=1 LOCALE_TR=1 LOCALE_HI=1 LOCALE_TW=1 LOCALE_AR=1 LOCALE_BN=1 LOCALE_UR=1

      - name: Build multi-language ISO
        run: make iso

      - name: Save multi-language artifacts
        run: |
          cp kernel.elf kernel-all-languages.elf
          cp system71.iso system71-all-languages.iso

      - name: Generate version
        id: version
        run: |
          if [[ "${{ steps.get_sha.outputs.IS_TAG }}" == "true" ]]; then
            # Use the tag version if triggered by a tag
            VERSION="${{ steps.get_sha.outputs.TAG_NAME }}"
          else
            # Auto-generate version: v0.1.{commit_count}-{short_sha}
            COMMIT_COUNT=$(git rev-list --count HEAD)
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="v0.1.${COMMIT_COUNT}-${SHORT_SHA}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Check if release exists
        id: check_release
        run: |
          if gh release view "${{ steps.version.outputs.VERSION }}" &>/dev/null; then
            echo "EXISTS=true" >> $GITHUB_OUTPUT
            echo "Release ${{ steps.version.outputs.VERSION }} already exists, will update it"
          else
            echo "EXISTS=false" >> $GITHUB_OUTPUT
            echo "Will create new release ${{ steps.version.outputs.VERSION }}"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: System7 ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: false
          files: |
            system71-en.iso
            kernel-en.elf
            system71-all-languages.iso
            kernel-all-languages.elf
          body: |
            ## System7 ${{ steps.version.outputs.VERSION }}

            **Commit:** ${{ steps.get_sha.outputs.SHA }}

            ### Downloads

            **English only (smaller image):**
            - `system71-en.iso` - Bootable ISO image (English)
            - `kernel-en.elf` - Kernel binary (English)

            **All languages (34 locales including English, French, German, Spanish, Italian, Portuguese, Dutch, Danish, Norwegian, Swedish, Finnish, Icelandic, Greek, Turkish, Polish, Czech, Slovak, Slovenian, Croatian, Hungarian, Romanian, Bulgarian, Albanian, Estonian, Latvian, Lithuanian, Macedonian, Montenegrin, Russian, Ukrainian, Japanese, Chinese, Korean, Hindi):**
            - `system71-all-languages.iso` - Bootable ISO image (all languages)
            - `kernel-all-languages.elf` - Kernel binary (all languages)

            ### Running
            ```bash
            # English only
            qemu-system-i386 -cdrom system71-en.iso -serial stdio -display sdl -m 256M

            # Multi-language (select language via GRUB boot parameter)
            # Available: en, fr, de, es, it, pt, nl, da, no, sv, fi, is, el, tr, pl, cs, sk, sl, hr, hu, ro, bg, sq, et, lv, lt, mk, me, ru, uk, ja, zh, ko, hi
            qemu-system-i386 -cdrom system71-all-languages.iso -serial stdio -display sdl -m 256M
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
